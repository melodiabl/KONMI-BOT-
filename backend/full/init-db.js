import knex from 'knex';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { existsSync, unlinkSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const dbPath = join(__dirname, 'storage', 'database.sqlite');

// Configuraci√≥n de Knex
const config = {
  client: 'sqlite3',
  connection: {
    filename: dbPath
  },
  useNullAsDefault: true,
  pool: {
    afterCreate: (conn, cb) => conn.run('PRAGMA foreign_keys = ON', cb)
  }
};

// Funci√≥n para crear la tabla subbots
async function createSubbotsTable() {
  const db = knex(config);
  
  try {
    // Verificar si la tabla ya existe
    const tableExists = await db.schema.hasTable('subbots');
    
    if (tableExists) {
      console.log('‚ÑπÔ∏è La tabla subbots ya existe. Eliminando...');
      await db.schema.dropTable('subbots');
    }
    
    // Crear la tabla con la estructura correcta
    console.log('üîÑ Creando tabla subbots...');
    await db.schema.createTable('subbots', (table) => {
      table.increments('id').primary();
      table.string('code').unique().notNullable();
      table.string('user_phone').notNullable();
      table.string('user_name').nullable();
      table.string('status').defaultTo('pending');
      table.string('connection_type').defaultTo('qr');
      table.text('qr_code').nullable();
      table.string('pairing_code').nullable();
      table.text('session_data').nullable();
      table.timestamp('created_at').defaultTo(db.fn.now());
      table.timestamp('last_activity').defaultTo(db.fn.now());
      table.timestamp('connected_at').nullable();
      table.boolean('is_active').defaultTo(false);
      table.integer('message_count').defaultTo(0);
      table.json('settings').nullable();
      
      // √çndices para optimizar consultas
      table.index('user_phone');
      table.index('status');
      table.index('is_active');
      table.index('last_activity');
    });
    
    console.log('‚úÖ Tabla subbots creada exitosamente');
    
  } catch (error) {
    console.error('‚ùå Error al crear la tabla subbots:', error);
    throw error;
  } finally {
    await db.destroy();
  }
}

// Funci√≥n principal
async function main() {
  try {
    console.log('üöÄ Inicializando base de datos...');
    
    // Crear la tabla subbots
    await createSubbotsTable();
    
    console.log('\n‚ú® Base de datos inicializada correctamente');
    console.log(`üìÅ Ubicaci√≥n: ${dbPath}`);
    
  } catch (error) {
    console.error('\n‚ùå Error durante la inicializaci√≥n:', error);
    process.exit(1);
  }
}

// Ejecutar la inicializaci√≥n
main();
