import { createSubbot, deleteSubbot, getSubbotAccessData } from '../handler.js';
import { db } from '../db.js';
import { db } from '../db.js';

let handler = async (m, { conn, args, usedPrefix, command }) => {
    if (!args[0]) {
        return m.reply(`‚ö†Ô∏è *Uso del comando:*
${usedPrefix + command} qr - Genera un c√≥digo QR para conectar
${usedPrefix + command} code - Genera un c√≥digo de emparejamiento
${usedPrefix + command} stop - Detiene tu sub-bot activo`);
    }

    const option = args[0].toLowerCase();
    const user = m.sender;

    switch (option) {
        case 'qr':
        case 'code':
            try {
                const existingStatus = await getSubbotStatus(user);
                const isActive = existingStatus?.active || false;

                if (isActive) {
                    return m.reply('‚ö†Ô∏è Ya tienes un sub-bot activo. Usa */subbot stop* para detenerlo primero.');
                }

                await m.reply('Iniciando tu sub-bot...');
                const connectionType = option === 'qr' ? 'qr' : 'pairing';
                const userName = m.pushName || 'Usuario';
                const result = await createSubbot(user, userName, connectionType);
                if (!result.success) throw new Error(result.error || 'Error al crear sub-bot');

                // If QR returned, send it as image; if pairing code, send code
                if (result.qr) {
                    try {
                        const qrBase64 = result.qr.replace(/^data:image\/(png|jpeg);base64,/, '');
                        const qrBuffer = Buffer.from(qrBase64, 'base64');
                        await conn.sendMessage(m.chat, { image: qrBuffer, caption: 'üì± Escanea este c√≥digo QR para conectar tu sub-bot\n‚è≥ El c√≥digo expira pronto' });
                    } catch (e) {
                        await m.reply('Se gener√≥ el QR pero no se pudo enviar la imagen. Usa /subbot status o el panel web.');
                    }
                } else if (result.pairingCode || result.pairingcode || result.code) {
                    const code = result.pairingCode || result.pairingcode || result.code;
                    await m.reply(`üîë Tu c√≥digo de emparejamiento es: *${code}*\n\nSigue las instrucciones en WhatsApp > Dispositivos vinculados.`);
                } else {
                    await m.reply('Sub-bot creado. Revisa el panel o espera a que se muestre el QR/c√≥digo.');
                }
            } catch (error) {
                console.error('Error en comando subbot:', error);
                m.reply(`‚ùå Error: ${error.message}`);
            }
            break;

        case 'stop':
            try {
                const status = await getSubbotStatus(user);
                if (!status?.active) {
                    return m.reply('‚ö†Ô∏è No tienes ning√∫n sub-bot activo.');
                }

                const result = await stopSubbot(user);
                
                if (result.success) {
                    m.reply('‚úÖ Sub-bot detenido correctamente.');
                } else {
                    throw new Error(result.error || 'Error al detener el sub-bot');
                }
            } catch (error) {
                console.error('Error deteniendo subbot:', error);
                m.reply(`‚ùå Error: ${error.message}`);
            }
            break;

        default:
            m.reply(`‚ö†Ô∏è Opci√≥n no v√°lida. Usa:
${usedPrefix + command} qr - Genera un c√≥digo QR para conectar
${usedPrefix + command} code - Genera un c√≥digo de emparejamiento
${usedPrefix + command} stop - Detiene tu sub-bot activo`);
    }
};

handler.help = ['subbot'];
handler.tags = ['subbots'];
handler.command = ['subbot'];
handler.register = true;

export default handler;